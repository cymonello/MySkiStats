@page "/auth-strava"
@using System.Text.Json.Serialization
@using MySkiStats.Services
@using Blazored.LocalStorage
@inject NavigationManager Navigation
@inject HttpClient Http
@inject TokenService TokenService
@inject ILocalStorageService LocalStorage

<div class="container mt-4">
    <h3>Strava Authentication</h3>

    @if (IsAuthenticated)
    {
        <div class="alert alert-success">
            <p>✓ Connected to Strava</p>
            <button class="btn btn-danger" @onclick="DisconnectStrava">Disconnect</button>
            <button class="btn btn-primary ms-2" @onclick="RefreshActivities">Refresh Activities</button>
        </div>

        @if (Activities?.Count > 0)
        {
            <h5 class="mt-3">Your Backcountry Ski Activities</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Distance (km)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var activity in Activities)
                    {
                        <tr>
                            <td>@activity.Name</td>
                            <td>@activity.StartDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>@(activity.Distance / 1000).ToString("F2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else if (IsLoading)
        {
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        }
        else
        {
            <p class="text-muted">No activities found.</p>
        }
    }
    else
    {
        <button class="btn btn-primary" @onclick="ConnectStrava">Connect to Strava</button>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger mt-3">@ErrorMessage</div>
    }
</div>

@code {
    private bool IsAuthenticated { get; set; }
    private bool IsLoading { get; set; }
    private string? ErrorMessage { get; set; }
    private List<Activity>? Activities { get; set; }

    private const string ClientId = "13023";
    private const string ClientSecret = "eb651c727a8c6a2956aec03f00bf3c6cb3dc8cd8";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Initialize token from local storage
            await TokenService.InitializeAsync();

            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var queryParams = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

            if (queryParams.TryGetValue("code", out var code))
            {
                // Exchange code for token
                var tokenResponse = await ExchangeCodeForToken(code);

                if (tokenResponse != null)
                {
                    await TokenService.SaveTokenAsync(tokenResponse);
                    IsAuthenticated = true;

                    // Clear the code from URL
                    Navigation.NavigateTo("/auth-strava", forceLoad: false);

                    // Automatically load activities
                    await RefreshActivities();
                }
                else
                {
                    ErrorMessage = "Failed to exchange authorization code for token.";
                }
            }
            else if (!string.IsNullOrEmpty(TokenService.AccessToken) && !TokenService.IsTokenExpired())
            {
                IsAuthenticated = true;
                await RefreshActivities();
            }
            else if (!string.IsNullOrEmpty(TokenService.RefreshToken))
            {
                // Try to refresh the token if expired
                if (await RefreshAccessToken())
                {
                    IsAuthenticated = true;
                    await RefreshActivities();
                }
                else
                {
                    await TokenService.ClearTokenAsync();
                    ErrorMessage = "Session expired. Please reconnect.";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
    }

    private void ConnectStrava()
    {
        var redirectUri = Navigation.ToAbsoluteUri("/auth-strava").ToString();
        var state = Guid.NewGuid().ToString();

        var authorizeUrl = $"https://www.strava.com/oauth/authorize" +
            $"?client_id={ClientId}" +
            $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
            $"&response_type=code" +
            $"&state={state}" +
            $"&scope=activity:read_all";

        Navigation.NavigateTo(authorizeUrl, forceLoad: true);
    }

    private async Task<TokenService.TokenResponse?> ExchangeCodeForToken(string code)
    {
        try
        {
            var redirectUri = Navigation.ToAbsoluteUri("/auth-strava").ToString();

            var requestData = new Dictionary<string, string>
            {
                { "client_id", ClientId },
                { "client_secret", ClientSecret },
                { "code", code },
                { "grant_type", "authorization_code" },
                { "redirect_uri", redirectUri }
            };

            var requestContent = new FormUrlEncodedContent(requestData);
            var response = await Http.PostAsync("https://www.strava.com/oauth/token", requestContent);

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                return System.Text.Json.JsonSerializer.Deserialize<TokenService.TokenResponse>(json);
            }

            ErrorMessage = $"Token exchange failed: {response.StatusCode}";
            return null;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Token exchange error: {ex.Message}";
            return null;
        }
    }

    private async Task<bool> RefreshAccessToken()
    {
        try
        {
            if (string.IsNullOrEmpty(TokenService.RefreshToken))
                return false;

            var requestData = new Dictionary<string, string>
            {
                { "client_id", ClientId },
                { "client_secret", ClientSecret },
                { "grant_type", "refresh_token" },
                { "refresh_token", TokenService.RefreshToken }
            };

            var requestContent = new FormUrlEncodedContent(requestData);
            var response = await Http.PostAsync("https://www.strava.com/oauth/token", requestContent);

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var tokenResponse = System.Text.Json.JsonSerializer.Deserialize<TokenService.TokenResponse>(json);

                if (tokenResponse != null)
                {
                    await TokenService.SaveTokenAsync(tokenResponse);
                    return true;
                }
            }

            return false;
        }
        catch
        {
            return false;
        }
    }

    private async Task RefreshActivities()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = null;

            if (TokenService.IsTokenExpired() && !await RefreshAccessToken())
            {
                ErrorMessage = "Session expired. Please reconnect.";
                IsAuthenticated = false;
                return;
            }

            Activities = await GetActivities();

            if (Activities == null)
            {
                ErrorMessage = "Failed to fetch activities from Strava.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading activities: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task<List<Activity>?> GetActivities()
    {
        try
        {
            if (string.IsNullOrEmpty(TokenService.AccessToken))
                return null;

            using var request = new HttpRequestMessage(HttpMethod.Get, "https://www.strava.com/api/v3/athlete/activities?type=BackcountrySki");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", TokenService.AccessToken);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                return System.Text.Json.JsonSerializer.Deserialize<List<Activity>>(json);
            }

            return null;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"API error: {ex.Message}";
            return null;
        }
    }

    private async Task DisconnectStrava()
    {
        await TokenService.ClearTokenAsync();
        IsAuthenticated = false;
        Activities = null;
        ErrorMessage = null;
    }

    public class Activity
    {
        [JsonPropertyName("name")]
        public string Name { get; set; } = default!;

        [JsonPropertyName("start_date")]
        public DateTime StartDate { get; set; }

        [JsonPropertyName("distance")]
        public float Distance { get; set; }
    }
}
